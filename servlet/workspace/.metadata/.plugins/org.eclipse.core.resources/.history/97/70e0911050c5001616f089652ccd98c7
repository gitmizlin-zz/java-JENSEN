package com.jensen;

import java.io.File;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletResponse;

@Webservlet("/UploadDownloadFileServlet")
public class UploadDownloadFileServlet extends HttpServlet {
	DiskFileItemFactory fileFactory = new DiskFileItemFactory();
	File filesDir = (File) getServletContext().getAttribute("FILES_DIR_FILE");
	fileFactory.setRepository(filesDir);
	this.uploader = new ServletFileUpload(fileFactory);
}

protected void doGet (HttpServletRequest resuest, HttpServletResponse response) 
		throws ServletException, IPException {
	String fileName = request.getParameter("fileName");
	
	if(fileName == null || fileName.equals("")) {
		throw new ServletException("File Name can't be bull or empty");
	}
	
	File file = new File(request.getServletContext().getAttribute("FILES_DIR") + File.separator + fileName);
	
	if (!file.exists()) {
		throw new ServletException("File does not found on server");
	}
	
	System.out.println("File location on server:: " + file.getAbsolutePath());
	ServletContext ctx = getServletContext();
	InputStream fis = new FileInputStream(file);
	String mimeType ctx.getMimeType(file.getAbsolutePath());
	response.setContentType(mimeType != null ? mimeType : "application/actet-stream");
	response.setContentLength((int) file.length());
	response.setHeader("Content-Disposition", "attachment; filename=\"" + fileName + "\"");
	
	ServletOutputStream os = response.getOutputStream();
	byte[] bufferData = new byte[1024];
	int read=0;
	
		while((read = fis.read(bufferData))!= -1){
			os.write(bufferData, 0, read);
		}
		os.flush();
		os.close();
		fis.close();
		System.out.println("File downloaded at client successfully");
}
	63
	 
	64
	    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
	65
	        if(!ServletFileUpload.isMultipartContent(request)){
	66
	            throw new ServletException("Content type is not multipart/form-data");
	67
	        }
	68
	 
	69
	        response.setContentType("text/html");
	70
	        PrintWriter out = response.getWriter();
	71
	        out.write("<html><head></head><body>");
	72
	        try {
	73
	            List<FileItem> fileItemsList = uploader.parseRequest(request);
	74
	            Iterator<FileItem> fileItemsIterator = fileItemsList.iterator();
	75
	            while(fileItemsIterator.hasNext()){
	76
	                FileItem fileItem = fileItemsIterator.next();
	77
	                System.out.println("FieldName="+fileItem.getFieldName());
	78
	                System.out.println("FileName="+fileItem.getName());
	79
	                System.out.println("ContentType="+fileItem.getContentType());
	80
	                System.out.println("Size in bytes="+fileItem.getSize());
	81
	 
	82
	                File file = new File(request.getServletContext().getAttribute("FILES_DIR")+File.separator+fileItem.getName());
	83
	                System.out.println("Absolute Path at server="+file.getAbsolutePath());
	84
	                fileItem.write(file);
	85
	                out.write("File "+fileItem.getName()+ " uploaded successfully.");
	86
	                out.write("<br>");
	87
	                out.write("<a href=\"UploadDownloadFileServlet?fileName="+fileItem.getName()+"\">Download "+fileItem.getName()+"</a>");
	88
	            }
	89
	        } catch (FileUploadException e) {
	90
	            out.write("Exception in uploading file.");
	91
	        } catch (Exception e) {
	92
	            out.write("Exception in uploading file.");
	93
	        }
	94
	        out.write("</body></html>");
	95
	    }
	96
	 
	97
	}

	
	
	
	
	
	
	
	
}
	